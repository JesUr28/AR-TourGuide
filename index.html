<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Modelo 3D en AR</title>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/jeromeetienne/AR.js/aframe/build/aframe-ar.min.js"></script>
    <script src="https://raw.githack.com/donmccurdy/aframe-extras/master/dist/aframe-extras.loaders.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/studio-backend/master/src/modules/marker/tools/gesture-detector.js"></script>
    <!-- Reemplazar el gesture-handler original con nuestra versión modificada -->
    <script>
        // Versión modificada del gesture-handler para manejar correctamente la rotación
        AFRAME.registerComponent('custom-gesture-handler', {
            schema: {
                enabled: { default: true },
                rotationFactor: { default: 5 },
                minScale: { default: 0.3 },
                maxScale: { default: 8 },
                yOnly: { default: true }
            },
            
            init: function() {
                this.handleScale = this.handleScale.bind(this);
                this.handleRotation = this.handleRotation.bind(this);
                
                this.isVisible = false;
                this.initialScale = { x: 1, y: 1, z: 1 };
                this.scaleFactor = 1;
                
                this.el.sceneEl.addEventListener('markerFound', (e) => {
                    if (e.target === this.el.parentNode) {
                        this.isVisible = true;
                        
                        // Guardar la escala inicial
                        const scale = this.el.getAttribute('scale');
                        this.initialScale = { x: scale.x, y: scale.y, z: scale.z };
                    }
                });
                
                this.el.sceneEl.addEventListener('markerLost', (e) => {
                    if (e.target === this.el.parentNode) {
                        this.isVisible = false;
                    }
                });
                
                // Registrar los eventos de gestos
                this.el.sceneEl.addEventListener('onefingermove', this.handleRotation);
                this.el.sceneEl.addEventListener('twofingermove', this.handleScale);
            },
            
            remove: function() {
                this.el.sceneEl.removeEventListener('onefingermove', this.handleRotation);
                this.el.sceneEl.removeEventListener('twofingermove', this.handleScale);
            },
            
            handleRotation: function(event) {
                if (!this.isVisible || !this.data.enabled) return;
                
                // Obtener la rotación actual
                const rotation = this.el.getAttribute('rotation');
                
                // Aplicar rotación solo en el eje Y (horizontal)
                if (this.data.yOnly) {
                    rotation.y += event.detail.positionChange.x * this.data.rotationFactor;
                } else {
                    rotation.y += event.detail.positionChange.x * this.data.rotationFactor;
                    rotation.x += event.detail.positionChange.y * this.data.rotationFactor;
                }
                
                // Aplicar la nueva rotación
                this.el.setAttribute('rotation', rotation);
            },
            
            handleScale: function(event) {
                if (!this.isVisible || !this.data.enabled) return;
                
                // Calcular el nuevo factor de escala
                this.scaleFactor *= 1 + event.detail.spreadChange / event.detail.startSpread;
                
                // Limitar el factor de escala
                this.scaleFactor = Math.min(Math.max(this.scaleFactor, this.data.minScale), this.data.maxScale);
                
                // Aplicar escala uniforme
                this.el.setAttribute('scale', {
                    x: this.initialScale.x * this.scaleFactor,
                    y: this.initialScale.y * this.scaleFactor,
                    z: this.initialScale.z * this.scaleFactor
                });
            }
        });
    </script>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div id="container">
        <!-- Contenedor del modelo 3D -->
        <div id="model-container">
            <a-scene embedded arjs="sourceType: webcam; detectionMode: mono_and_matrix; debugUIEnabled: false; matrixCodeType: 3x3; smoothCount: 15; smoothTolerance: 0.01; smoothThreshold: 5;"
                     vr-mode-ui="enabled: false" renderer="logarithmicDepthBuffer: true; alpha: true; precision: high; antialias: true;"
                     gesture-detector>
                <a-assets>
                    <a-asset-item id="honestidad" src="https://cdn.glitch.global/f24dfbcf-5d5a-489d-b6c0-b547e6c91644/HONESTIDADP1.glb"></a-asset-item>
                    <a-asset-item id="respeto" src="https://cdn.glitch.global/f24dfbcf-5d5a-489d-b6c0-b547e6c91644/RESPETOP1.glb"></a-asset-item>  <!-- prudencia -->
                    <a-asset-item id="justicia" src="https://cdn.glitch.global/f24dfbcf-5d5a-489d-b6c0-b547e6c91644/JUSTICIAP1.glb"></a-asset-item>
                    <a-asset-item id="compromiso" src="https://cdn.glitch.global/f24dfbcf-5d5a-489d-b6c0-b547e6c91644/COMPROMISOP1.glb"></a-asset-item>
                    <a-asset-item id="diligencia" src="https://cdn.glitch.global/f24dfbcf-5d5a-489d-b6c0-b547e6c91644/DILIGENCIAP1.glb"></a-asset-item>
                    <a-asset-item id="veracidad" src="https://cdn.glitch.global/f24dfbcf-5d5a-489d-b6c0-b547e6c91644/VERACIDADP1.glb"></a-asset-item>
                </a-assets>
                
                <!-- Marcadores con estructura simplificada -->
                <a-marker type="pattern" url="markers/pattern-H.patt" id="marker-honestidad" emitevents="true" smooth="true" smoothCount="10" smoothTolerance="0.01" smoothThreshold="5">
                    <a-entity id="honestidad-model" gltf-model="#honestidad" scale="1 1 1"
                            position="0 -1.5 0" rotation="-90 0 0" animation-mixer="loop: repeat" 
                            class="clickable" custom-gesture-handler="minScale: 0.3; maxScale: 8; rotationFactor: 5; yOnly: true">
                    </a-entity>
                </a-marker>
                
                <a-marker type="pattern" url="markers/pattern-R.patt" id="marker-respeto" emitevents="true" smooth="true" smoothCount="10" smoothTolerance="0.01" smoothThreshold="5">
                    <a-entity id="respeto-model" gltf-model="#respeto" scale="1 1 1"
                            position="0 -1.5 0" rotation="-90 0 0" animation-mixer="loop: repeat" 
                            class="clickable" custom-gesture-handler="minScale: 0.3; maxScale: 8; rotationFactor: 5; yOnly: true">
                    </a-entity>
                </a-marker>
                
                <a-marker type="pattern" url="markers/pattern-J.patt" id="marker-justicia" emitevents="true" smooth="true" smoothCount="10" smoothTolerance="0.01" smoothThreshold="5">
                    <a-entity id="justicia-model" gltf-model="#justicia" scale="1 1 1"
                            position="0 -1.5 0" rotation="-90 0 0" animation-mixer="loop: repeat" 
                            class="clickable" custom-gesture-handler="minScale: 0.3; maxScale: 8; rotationFactor: 5; yOnly: true">
                    </a-entity>
                </a-marker>

                <a-marker type="pattern" url="markers/pattern-C.patt" id="marker-compromiso" emitevents="true" smooth="true" smoothCount="10" smoothTolerance="0.01" smoothThreshold="5">
                    <a-entity id="compromiso-model" gltf-model="#compromiso" scale="1 1 1"
                            position="0 -1.5 0" rotation="-90 0 0" animation-mixer="loop: repeat" 
                            class="clickable" custom-gesture-handler="minScale: 0.3; maxScale: 8; rotationFactor: 5; yOnly: true">
                    </a-entity>
                </a-marker>
                
                <a-marker type="pattern" url="markers/pattern-D.patt" id="marker-diligencia" emitevents="true" smooth="true" smoothCount="10" smoothTolerance="0.01" smoothThreshold="5">
                    <a-entity id="diligencia-model" gltf-model="#diligencia" scale="1 1 1"
                            position="0 -1.5 0" rotation="-90 0 0" animation-mixer="loop: repeat" 
                            class="clickable" custom-gesture-handler="minScale: 0.3; maxScale: 8; rotationFactor: 5; yOnly: true">
                    </a-entity>
                </a-marker>

                <a-marker type="pattern" url="markers/pattern-VR.patt" id="marker-veracidad" emitevents="true" smooth="true" smoothCount="10" smoothTolerance="0.01" smoothThreshold="5">
                    <a-entity id="veracidad-model" gltf-model="#veracidad" scale="1 1 1"
                            position="0 -1.5 0" rotation="-90 0 0" animation-mixer="loop: repeat" 
                            class="clickable" custom-gesture-handler="minScale: 0.3; maxScale: 8; rotationFactor: 5; yOnly: true">
                    </a-entity>
                </a-marker>
                
                <a-entity camera></a-entity>
            </a-scene>
        </div>
        
        <!-- Contenedor del texto -->
        <div id="info-box">
            <div class="button-container">
                <button id="play-btn" class="speak-button hidden">
                    <span id="play-text">▶️ Reproducir</span>
                    <span id="loading-text" class="hidden">
                        <span class="loading-spinner"></span> Cargando...
                    </span>
                </button>
                <button id="stop-btn" class="speak-button hidden">⏹️ Detener</button>
                <button id="scan-new-btn" class="speak-button hidden">🔍 Escanear nuevo</button>
            </div>
            <div id="instruction-message" class="instruction">
                <h2>Instrucciones</h2>
                <p>Escanea uno de los marcadores para ver el modelo 3D y su información.</p>
                <p><strong>Gestos:</strong> Usa <strong>un dedo</strong> para rotar y <strong>dos dedos</strong> para acercar/alejar.</p>
            </div>
            <h2 id="title" class="hidden"></h2>
            <p id="valor-text" class="hidden"></p>
        </div>
    </div>
    
    <div id="desktop-warning">
        <h2>¡Atención!</h2>
        <p>Esta aplicación está diseñada exclusivamente para dispositivos móviles. En pantallas grandes, el diseño puede verse distorsionado y la experiencia AR no funcionará correctamente.</p>
        <div>
            <button id="back-btn">Regresar</button>
        </div>
    </div>
    
    <script src="script.js"></script>
</body>
</html>

